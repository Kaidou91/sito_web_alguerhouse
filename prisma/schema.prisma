generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  users       User[]
}

model User {
  id         String    @id @default(cuid())
  email      String    @unique
  password   String?
  name       String?
  phone      String?
  roleId     String
  role       Role      @relation(fields: [roleId], references: [id])
  bookings   Booking[]
  auditLogs  AuditLog[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model RoomType {
  id             String     @id @default(cuid())
  code           String     @unique
  name           Json
  description    Json?
  capacityAdults Int
  capacityKids   Int
  bedConfig      String
  basePrice      Decimal    @db.Decimal(10, 2)
  inventory      Int
  amenities      String[]
  images         String[]
  ratePlans      RatePlan[]
  seasons        Season[]   @relation("SeasonRoomTypes")
  rooms          Room[]
  bookings       Booking[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model Room {
  id         String     @id @default(cuid())
  roomNumber String     @unique
  roomTypeId String
  roomType   RoomType   @relation(fields: [roomTypeId], references: [id])
  status     RoomStatus @default(ACTIVE)
  notes      String?
  closures   Closure[]
  bookings   Booking[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

enum RoomStatus {
  ACTIVE
  MAINTENANCE
  BLOCKED
}

model Season {
  id         String     @id @default(cuid())
  name       Json
  startDate  DateTime
  endDate    DateTime
  seasonType SeasonType
  roomTypes  RoomType[] @relation("SeasonRoomTypes")
  ratePlans  RatePlan[]
}

enum SeasonType {
  HIGH
  MID
  LOW
}

model RatePlan {
  id               String         @id @default(cuid())
  code             String         @unique
  name             Json
  description      Json?
  roomTypeId       String
  roomType         RoomType       @relation(fields: [roomTypeId], references: [id])
  seasonId         String?
  season           Season?        @relation(fields: [seasonId], references: [id])
  pricePerNight    Decimal        @db.Decimal(10, 2)
  currency         String         @default("EUR")
  refundable       Boolean        @default(true)
  cancelBeforeDays Int?
  paymentPolicy    PaymentPolicy  @default(DEPOSIT_30)
  minNights        Int            @default(1)
  maxNights        Int?
  arrivalDays      String[]
  checkInTime      String
  checkOutTime     String
  taxes            Tax[]          @relation("RatePlanTaxes")
  extras           Extra[]        @relation("RatePlanExtras")
  restrictions     Restriction[]
  coupons          Coupon[]       @relation("RatePlanCoupons")
  bookings         Booking[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

enum PaymentPolicy {
  DEPOSIT_30
  FULL_PREPAY
  PREAUTH
}

model Restriction {
  id                 String     @id @default(cuid())
  ratePlanId         String
  ratePlan           RatePlan   @relation(fields: [ratePlanId], references: [id])
  minAdvanceDays     Int?
  maxAdvanceDays     Int?
  closedToArrival    Boolean    @default(false)
  closedToDeparture  Boolean    @default(false)
  blockedDates       Json
}

model Extra {
  id          String      @id @default(cuid())
  code        String      @unique
  name        Json
  description Json?
  price       Decimal     @db.Decimal(10, 2)
  unit        ExtraUnit
  perNight    Boolean     @default(false)
  perPerson   Boolean     @default(false)
  ratePlans   RatePlan[]  @relation("RatePlanExtras")
}

enum ExtraUnit {
  STAY
  NIGHT
  PERSON
}

model Tax {
  id          String     @id @default(cuid())
  name        Json
  description Json?
  percentage  Decimal?   @db.Decimal(5, 2)
  flatAmount  Decimal?   @db.Decimal(10, 2)
  perPerson   Boolean    @default(false)
  perNight    Boolean    @default(false)
  ratePlans   RatePlan[] @relation("RatePlanTaxes")
}

model Coupon {
  id           String     @id @default(cuid())
  code         String     @unique
  description  Json?
  discountPct  Decimal?   @db.Decimal(5, 2)
  discountFlat Decimal?   @db.Decimal(10, 2)
  startDate    DateTime
  endDate      DateTime
  maxUses      Int?
  usedCount    Int        @default(0)
  ratePlans    RatePlan[] @relation("RatePlanCoupons")
}

model Closure {
  id        String   @id @default(cuid())
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id])
  startDate DateTime
  endDate   DateTime
  reason    String?
}

model Booking {
  id             String         @id @default(cuid())
  code           String         @unique
  roomTypeId     String
  roomType       RoomType       @relation(fields: [roomTypeId], references: [id])
  roomId         String?
  room           Room?          @relation(fields: [roomId], references: [id])
  ratePlanId     String
  ratePlan       RatePlan       @relation(fields: [ratePlanId], references: [id])
  userId         String?
  user           User?          @relation(fields: [userId], references: [id])
  checkIn        DateTime
  checkOut       DateTime
  adults         Int
  children       Int
  status         BookingStatus  @default(PENDING)
  paymentStatus  PaymentStatus  @default(PENDING)
  totalAmount    Decimal        @db.Decimal(10, 2)
  depositAmount  Decimal        @db.Decimal(10, 2)
  balanceAmount  Decimal        @db.Decimal(10, 2)
  currency       String         @default("EUR")
  taxBreakdown   Json
  extrasSelected Json
  couponCode     String?
  notes          String?
  guestFirstName String
  guestLastName  String
  guestEmail     String
  guestPhone     String
  auditLogs      AuditLog[]
  payments       Payment[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  REFUNDED
  PARTIAL_REFUND
  FAILED
}

model Payment {
  id          String          @id @default(cuid())
  bookingId   String
  booking     Booking         @relation(fields: [bookingId], references: [id])
  provider    PaymentProvider
  intentId    String?
  amount      Decimal         @db.Decimal(10, 2)
  currency    String          @default("EUR")
  status      PaymentStatus
  method      String?
  capturedAt  DateTime?
  refundedAt  DateTime?
  metadata    Json?
  createdAt   DateTime        @default(now())
}

enum PaymentProvider {
  STRIPE
  PAYPAL
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  bookingId String?
  booking   Booking? @relation(fields: [bookingId], references: [id])
  action    String
  details   Json?
  createdAt DateTime @default(now())
}

model ContentBlock {
  id        String  @id @default(cuid())
  page      PageKey
  section   String
  locale    String
  title     String?
  subtitle  String?
  body      Json?
  media     String[]
  seoTitle  String?
  seoDesc   String?
  slug      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PageKey {
  HOME
  ROOMS
  SERVICES
  EXPLORE
  GALLERY
  FAQ
  CONTACTS
  BOOKING
  LEGAL_PRIVACY
  LEGAL_TERMS
}
